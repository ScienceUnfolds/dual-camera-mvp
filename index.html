<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personalized Horoscope</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #3b82f6;
            border-radius: 50%;
            width: 3rem;
            height: 3rem;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <div class="container mx-auto p-6 bg-white rounded-xl shadow-lg w-full max-w-4xl">
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-800 mb-2">Personalized Horoscope & Astrology</h1>
            <p class="text-gray-600">Enter your details to get your unique astrological insights.</p>
        </div>

        <!-- Input Form -->
        <form id="horoscope-form" class="space-y-6">
            <!-- Language Selection -->
            <div>
                <label for="language" class="block text-sm font-medium text-gray-700">Select Language</label>
                <select id="language" name="language" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md shadow-sm">
                    <option value="en">English</option>
                    <option value="ne">Nepali</option>
                </select>
            </div>

            <!-- Name Input -->
            <div>
                <label for="name" class="block text-sm font-medium text-gray-700">Full Name</label>
                <input type="text" id="name" name="name" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="e.g., John Doe">
            </div>

            <!-- Date of Birth Input -->
            <div>
                <label for="dob" class="block text-sm font-medium text-gray-700">Date of Birth</label>
                <input type="date" id="dob" name="dob" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
            </div>

            <!-- Birth Place Input -->
            <div>
                <label for="birthplace" class="block text-sm font-medium text-gray-700">Birth Place</label>
                <input type="text" id="birthplace" name="birthplace" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="e.g., Kathmandu, Nepal">
            </div>

            <!-- Submit Button -->
            <div>
                <button type="submit" id="submit-btn" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-all duration-200 ease-in-out">
                    <i class="fa-solid fa-magic mr-2"></i> Get My Horoscope
                </button>
            </div>
        </form>

        <!-- Loading Indicator -->
        <div id="loading" class="hidden flex justify-center items-center mt-8">
            <div class="loading-spinner"></div>
        </div>
        
        <!-- Results Section -->
        <div id="results" class="hidden mt-8 space-y-6">
            <!-- Personalized details and horoscopes will be inserted here by JavaScript -->
            <div id="astrological-details-card" class="bg-gray-50 p-6 rounded-lg shadow-sm">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">Astrological Details</h2>
                <div id="astrological-details"></div>
            </div>

            <div id="horoscope-card" class="bg-gray-50 p-6 rounded-lg shadow-sm">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">Horoscopes</h2>
                <div id="daily-horoscope-section">
                    <h3 class="text-lg font-medium text-gray-700 mb-2">Daily Horoscope</h3>
                    <div id="daily-horoscope"></div>
                </div>
                <div id="weekly-horoscope-section" class="mt-4">
                    <h3 class="text-lg font-medium text-gray-700 mb-2">Weekly Horoscope</h3>
                    <div id="weekly-horoscope"></div>
                </div>
                <div id="monthly-horoscope-section" class="mt-4">
                    <h3 class="text-lg font-medium text-gray-700 mb-2">Monthly Horoscope</h3>
                    <div id="monthly-horoscope"></div>
                </div>
                <div id="yearly-horoscope-section" class="mt-4">
                    <h3 class="text-lg font-medium text-gray-700 mb-2">Yearly Horoscope</h3>
                    <div id="yearly-horoscope"></div>
                </div>
                <div id="life-stages-section" class="mt-4">
                    <h3 class="text-lg font-medium text-gray-700 mb-2">Life Stages</h3>
                    <div id="life-stages"></div>
                </div>
            </div>

            <div id="relationships-card" class="bg-gray-50 p-6 rounded-lg shadow-sm">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">Daily Relationship Insights</h2>
                <div id="relationships"></div>
            </div>
        </div>

        <!-- Custom Alert/Error Modal -->
        <div id="alert-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden flex items-center justify-center p-4">
            <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm">
                <h3 class="text-lg font-medium text-gray-900" id="alert-title"></h3>
                <div class="mt-2 text-sm text-gray-500" id="alert-message"></div>
                <div class="mt-4 flex justify-end">
                    <button type="button" id="alert-ok-btn" class="inline-flex justify-center rounded-md border border-transparent bg-blue-100 px-4 py-2 text-sm font-medium text-blue-900 hover:bg-blue-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                        OK
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const form = document.getElementById('horoscope-form');
            const submitBtn = document.getElementById('submit-btn');
            const loading = document.getElementById('loading');
            const resultsDiv = document.getElementById('results');
            const alertModal = document.getElementById('alert-modal');
            const alertTitle = document.getElementById('alert-title');
            const alertMessage = document.getElementById('alert-message');
            const alertOkBtn = document.getElementById('alert-ok-btn');

            // Load saved user details from local storage
            const savedDetails = localStorage.getItem('horoscopeUserDetails');
            if (savedDetails) {
                const userDetails = JSON.parse(savedDetails);
                document.getElementById('name').value = userDetails.name || '';
                document.getElementById('dob').value = userDetails.dob || '';
                document.getElementById('birthplace').value = userDetails.birthplace || '';
                document.getElementById('language').value = userDetails.language || 'en';
            }

            // Set up a custom alert function to replace the browser's alert()
            function showAlert(title, message) {
                alertTitle.textContent = title;
                alertMessage.textContent = message;
                alertModal.classList.remove('hidden');
                alertModal.classList.add('flex');
            }

            alertOkBtn.addEventListener('click', () => {
                alertModal.classList.add('hidden');
                alertModal.classList.remove('flex');
            });

            form.addEventListener('submit', async (e) => {
                e.preventDefault();

                const name = document.getElementById('name').value;
                const dob = document.getElementById('dob').value;
                const birthplace = document.getElementById('birthplace').value;
                const language = document.getElementById('language').value;

                // Save user details to local storage
                const userDetails = { name, dob, birthplace, language };
                localStorage.setItem('horoscopeUserDetails', JSON.stringify(userDetails));

                // Show loading indicator and hide results
                loading.classList.remove('hidden');
                resultsDiv.classList.add('hidden');
                submitBtn.disabled = true;
                submitBtn.textContent = (language === 'ne' ? 'कृपया पर्खनुहोस्...' : 'Please wait...');

                try {
                    const data = await getAstrologicalData({ name, dob, birthplace, language });
                    if (data) {
                        displayResults(data, language);
                        resultsDiv.classList.remove('hidden');
                    } else {
                        showAlert('Error', language === 'ne' ? 'ज्योतिषीय विवरण प्राप्त गर्न सकिएन। कृपया फेरि प्रयास गर्नुहोस्।' : 'Could not retrieve astrological details. Please try again.');
                    }
                } catch (error) {
                    console.error('Error fetching data:', error);
                    showAlert('Error', language === 'ne' ? 'एक त्रुटि भयो। कृपया फेरि प्रयास गर्नुहोस्।' : 'An error occurred. Please try again.');
                } finally {
                    // Hide loading indicator and re-enable button
                    loading.classList.add('hidden');
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = `<i class="fa-solid fa-magic mr-2"></i> ${language === 'ne' ? 'मेरो राशिफल प्राप्त गर्नुहोस्' : 'Get My Horoscope'}`;
                }
            });

            async function getAstrologicalData({ name, dob, birthplace, language }) {
                const promptText = `Generate detailed astrological details and horoscopes for a person with the following information. The response must be a single JSON object. Do not include any text outside the JSON object.
                Language: ${language === 'ne' ? 'Nepali' : 'English'}.
                Name: ${name}.
                Date of Birth: ${dob}.
                Birth Place: ${birthplace}.
                
                The JSON object should have the following keys and values (please ensure all values are strings):
                - "astrological_details": A detailed paragraph about their zodiac sign and planetary influences.
                - "daily_horoscope": A short paragraph for their daily horoscope.
                - "weekly_horoscope": A short paragraph for their weekly horoscope.
                - "monthly_horoscope": A short paragraph for their monthly horoscope.
                - "yearly_horoscope": A detailed paragraph for their yearly horoscope.
                - "life_stages": A detailed paragraph about horoscopes for different life stages (e.g., youth, adulthood, old age).
                - "relationships": A paragraph about their daily relationships with family (dad, mom, siblings) and spouse/kids.
                `;

                const chatHistory = [{ role: "user", parts: [{ text: promptText }] }];
                const payload = {
                    contents: chatHistory,
                    generationConfig: {
                        responseMimeType: "application/json"
                    }
                };

                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

                let retryCount = 0;
                const maxRetries = 5;
                const initialDelay = 1000; // 1 second

                while (retryCount < maxRetries) {
                    try {
                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (!response.ok) {
                            if (response.status === 429) { // Too Many Requests
                                const delay = initialDelay * Math.pow(2, retryCount);
                                console.warn(`API rate limit exceeded. Retrying in ${delay}ms...`);
                                await new Promise(resolve => setTimeout(resolve, delay));
                                retryCount++;
                                continue;
                            } else {
                                throw new Error(`API returned status code: ${response.status}`);
                            }
                        }

                        const result = await response.json();
                        if (result.candidates && result.candidates.length > 0 &&
                            result.candidates[0].content && result.candidates[0].content.parts &&
                            result.candidates[0].content.parts.length > 0) {
                            const jsonText = result.candidates[0].content.parts[0].text;
                            // Attempt to parse JSON. Sometimes the LLM includes extra text.
                            try {
                                return JSON.parse(jsonText);
                            } catch (parseError) {
                                console.error('Failed to parse JSON:', parseError);
                                // Try to extract JSON from the text
                                const jsonMatch = jsonText.match(/\{[\s\S]*\}/);
                                if (jsonMatch) {
                                    return JSON.parse(jsonMatch[0]);
                                }
                                throw new Error('Invalid JSON format received from API.');
                            }
                        } else {
                            throw new Error('Unexpected API response structure or no content.');
                        }
                    } catch (error) {
                        console.error('Fetch error:', error);
                        throw error;
                    }
                }
                throw new Error('Max API retries exceeded.');
            }

            function displayResults(data, language) {
                const labels = {
                    en: {
                        astrologicalDetails: 'Astrological Details',
                        dailyHoroscope: 'Daily Horoscope',
                        weeklyHoroscope: 'Weekly Horoscope',
                        monthlyHoroscope: 'Monthly Horoscope',
                        yearlyHoroscope: 'Yearly Horoscope',
                        lifeStages: 'Life Stages',
                        relationships: 'Daily Relationship Insights'
                    },
                    ne: {
                        astrologicalDetails: 'ज्योतिषीय विवरण',
                        dailyHoroscope: 'दैनिक राशिफल',
                        weeklyHoroscope: 'साप्ताहिक राशिफल',
                        monthlyHoroscope: 'मासिक राशिफल',
                        yearlyHoroscope: 'वार्षिक राशिफल',
                        lifeStages: 'जीवनका चरणहरू',
                        relationships: 'दैनिक सम्बन्धको जानकारी'
                    }
                };

                document.getElementById('astrological-details-card').querySelector('h2').textContent = labels[language].astrologicalDetails;
                document.getElementById('horoscope-card').querySelector('h2').textContent = labels[language].weeklyHoroscope;
                document.getElementById('daily-horoscope-section').querySelector('h3').textContent = labels[language].dailyHoroscope;
                document.getElementById('weekly-horoscope-section').querySelector('h3').textContent = labels[language].weeklyHoroscope;
                document.getElementById('monthly-horoscope-section').querySelector('h3').textContent = labels[language].monthlyHoroscope;
                document.getElementById('yearly-horoscope-section').querySelector('h3').textContent = labels[language].yearlyHoroscope;
                document.getElementById('life-stages-section').querySelector('h3').textContent = labels[language].lifeStages;
                document.getElementById('relationships-card').querySelector('h2').textContent = labels[language].relationships;

                document.getElementById('astrological-details').innerHTML = `<p class="text-gray-600">${data.astrological_details}</p>`;
                document.getElementById('daily-horoscope').innerHTML = `<p class="text-gray-600">${data.daily_horoscope}</p>`;
                document.getElementById('weekly-horoscope').innerHTML = `<p class="text-gray-600">${data.weekly_horoscope}</p>`;
                document.getElementById('monthly-horoscope').innerHTML = `<p class="text-gray-600">${data.monthly_horoscope}</p>`;
                document.html = `<p class="text-gray-600">${data.yearly_horoscope}</p>`;
                document.getElementById('life-stages').innerHTML = `<p class="text-gray-600">${data.life_stages}</p>`;
                document.getElementById('relationships').innerHTML = `<p class="text-gray-600">${data.relationships}</p>`;
            }
        });
    </script>
</body>
</html>
