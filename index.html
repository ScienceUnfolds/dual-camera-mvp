<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personalized Horoscope</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #3b82f6;
            border-radius: 50%;
            width: 3rem;
            height: 3rem;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        .accordion-content.active {
            max-height: 1000px; /* A large number to allow for content expansion */
            transition: max-height 0.5s ease-in;
        }
        .rotated-icon {
            transform: rotate(180deg);
            transition: transform 0.3s ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <div class="container mx-auto p-6 bg-white rounded-xl shadow-lg w-full max-w-4xl">
        <div class="text-center mb-8">
            <h1 id="main-title" class="text-4xl font-bold text-gray-800 mb-2">Personalized Horoscope & Astrology</h1>
            <p id="main-subtitle" class="text-gray-600">Enter your details to get your unique astrological insights.</p>
        </div>

        <!-- Input Form -->
        <form id="horoscope-form" class="space-y-6">
            <!-- Language Selection -->
            <div>
                <label for="language" id="label-language" class="block text-sm font-medium text-gray-700">Select Language</label>
                <select id="language" name="language" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md shadow-sm">
                    <option value="en">English</option>
                    <option value="ne">Nepali</option>
                    <option value="hi">Hindi</option>
                </select>
            </div>

            <!-- Name Input -->
            <div>
                <label for="name" id="label-name" class="block text-sm font-medium text-gray-700">Full Name</label>
                <input type="text" id="name" name="name" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="e.g., John Doe">
            </div>

            <!-- Date of Birth Input -->
            <div>
                <label for="dob" id="label-dob" class="block text-sm font-medium text-gray-700">Date of Birth</label>
                <input type="date" id="dob" name="dob" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
            </div>

            <!-- Birth Place Input -->
            <div>
                <label for="birthplace" id="label-birthplace" class="block text-sm font-medium text-gray-700">Birth Place</label>
                <input type="text" id="birthplace" name="birthplace" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="e.g., Kathmandu, Nepal">
            </div>

            <!-- Submit Button -->
            <div>
                <button type="submit" id="submit-btn" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-all duration-200 ease-in-out">
                    <i class="fa-solid fa-magic mr-2"></i> Get My Horoscope
                </button>
            </div>
        </form>

        <!-- Loading Indicator -->
        <div id="loading" class="hidden flex justify-center items-center mt-8">
            <div class="loading-spinner"></div>
        </div>
        
        <!-- Results Section with Accordion -->
        <div id="results" class="hidden mt-8 space-y-4">
            
            <!-- User Information Section -->
            <div id="user-info-card" class="bg-gray-50 p-6 rounded-lg shadow-sm">
                <h2 id="user-info-header" class="text-2xl font-semibold text-gray-800 mb-4">User Details</h2>
                <div id="user-info"></div>
            </div>

            <!-- Astrological Details Section -->
            <div id="astrological-details-card" class="bg-gray-50 p-6 rounded-lg shadow-sm">
                <h2 id="astrological-details-header" class="text-2xl font-semibold text-gray-800 mb-4">Astrological Details</h2>
                <div id="astrological-details"></div>
            </div>

            <!-- Horoscope Accordion -->
            <div class="bg-white rounded-lg shadow-sm overflow-hidden">
                <h2 id="horoscope-header" class="text-2xl font-semibold text-gray-800 mb-4 p-4">Horoscopes</h2>
                
                <!-- Daily Horoscope Accordion Item -->
                <div class="border-t border-gray-200">
                    <button class="accordion-header w-full text-left p-4 flex justify-between items-center bg-gray-100 hover:bg-gray-200 transition-colors duration-200" data-target="daily-horoscope-content">
                        <span class="text-lg font-medium text-gray-700 flex items-center"><i class="fas fa-sun mr-3 text-yellow-500"></i><span id="daily-horoscope-title">Daily Horoscope</span></span>
                        <i class="fas fa-chevron-down text-gray-500 transition-transform duration-200"></i>
                    </button>
                    <div id="daily-horoscope-content" class="accordion-content p-4 bg-white">
                        <div id="daily-horoscope" class="text-gray-600">
                            <p>Loading...</p>
                        </div>
                    </div>
                </div>

                <!-- Weekly Horoscope Accordion Item -->
                <div class="border-t border-gray-200">
                    <button class="accordion-header w-full text-left p-4 flex justify-between items-center bg-gray-100 hover:bg-gray-200 transition-colors duration-200" data-target="weekly-horoscope-content">
                        <span class="text-lg font-medium text-gray-700 flex items-center"><i class="fas fa-calendar-week mr-3 text-blue-500"></i><span id="weekly-horoscope-title">Weekly Horoscope</span></span>
                        <i class="fas fa-chevron-down text-gray-500 transition-transform duration-200"></i>
                    </button>
                    <div id="weekly-horoscope-content" class="accordion-content p-4 bg-white">
                        <div id="weekly-horoscope" class="text-gray-600">
                            <p>Loading...</p>
                        </div>
                    </div>
                </div>

                <!-- Monthly Horoscope Accordion Item -->
                <div class="border-t border-gray-200">
                    <button class="accordion-header w-full text-left p-4 flex justify-between items-center bg-gray-100 hover:bg-gray-200 transition-colors duration-200" data-target="monthly-horoscope-content">
                        <span class="text-lg font-medium text-gray-700 flex items-center"><i class="fas fa-calendar-days mr-3 text-green-500"></i><span id="monthly-horoscope-title">Monthly Horoscope</span></span>
                        <i class="fas fa-chevron-down text-gray-500 transition-transform duration-200"></i>
                    </button>
                    <div id="monthly-horoscope-content" class="accordion-content p-4 bg-white">
                        <div id="monthly-horoscope" class="text-gray-600">
                            <p>Loading...</p>
                        </div>
                    </div>
                </div>

                <!-- Yearly Horoscope Accordion Item -->
                <div class="border-t border-gray-200">
                    <button class="accordion-header w-full text-left p-4 flex justify-between items-center bg-gray-100 hover:bg-gray-200 transition-colors duration-200" data-target="yearly-horoscope-content">
                        <span class="text-lg font-medium text-gray-700 flex items-center"><i class="fas fa-calendar-alt mr-3 text-purple-500"></i><span id="yearly-horoscope-title">Yearly Horoscope</span></span>
                        <i class="fas fa-chevron-down text-gray-500 transition-transform duration-200"></i>
                    </button>
                    <div id="yearly-horoscope-content" class="accordion-content p-4 bg-white">
                        <div id="yearly-horoscope" class="text-gray-600">
                            <p>Loading...</p>
                        </div>
                    </div>
                </div>

                <!-- Life Stages Accordion Item -->
                <div class="border-t border-gray-200">
                    <button class="accordion-header w-full text-left p-4 flex justify-between items-center bg-gray-100 hover:bg-gray-200 transition-colors duration-200" data-target="life-stages-content">
                        <span class="text-lg font-medium text-gray-700 flex items-center"><i class="fas fa-seedling mr-3 text-orange-500"></i><span id="life-stages-title">Life Stages</span></span>
                        <i class="fas fa-chevron-down text-gray-500 transition-transform duration-200"></i>
                    </button>
                    <div id="life-stages-content" class="accordion-content p-4 bg-white">
                        <div id="life-stages" class="text-gray-600">
                            <p>Loading...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Relationships Section -->
            <div id="relationships-card" class="bg-gray-50 p-6 rounded-lg shadow-sm">
                <h2 id="relationships-header" class="text-2xl font-semibold text-gray-800 mb-4">Daily Relationship Insights</h2>
                <div id="relationships"></div>
            </div>
        </div>

        <!-- Custom Alert/Error Modal -->
        <div id="alert-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden flex items-center justify-center p-4">
            <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm">
                <h3 class="text-lg font-medium text-gray-900" id="alert-title"></h3>
                <div class="mt-2 text-sm text-gray-500" id="alert-message"></div>
                <div class="mt-4 flex justify-end">
                    <button type="button" id="alert-ok-btn" class="inline-flex justify-center rounded-md border border-transparent bg-blue-100 px-4 py-2 text-sm font-medium text-blue-900 hover:bg-blue-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                        OK
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const form = document.getElementById('horoscope-form');
            const submitBtn = document.getElementById('submit-btn');
            const loading = document.getElementById('loading');
            const resultsDiv = document.getElementById('results');
            const userInfoDiv = document.getElementById('user-info');
            const alertModal = document.getElementById('alert-modal');
            const alertTitle = document.getElementById('alert-title');
            const alertMessage = document.getElementById('alert-message');
            const alertOkBtn = document.getElementById('alert-ok-btn'); 
            const languageSelect = document.getElementById('language');

            const translations = {
                en: {
                    mainTitle: 'Personalized Horoscope & Astrology',
                    mainSubtitle: 'Enter your details to get your unique astrological insights.',
                    labelLanguage: 'Select Language',
                    labelName: 'Full Name',
                    placeholderName: 'e.g., John Doe',
                    labelDob: 'Date of Birth',
                    labelBirthplace: 'Birth Place',
                    placeholderBirthplace: 'e.g., Kathmandu, Nepal',
                    submitBtn: 'Get My Horoscope',
                    pleaseWait: 'Please wait...',
                    errorTitle: 'Error',
                    errorMessage: 'Please fill in all the details.',
                    errorRetrieval: 'Could not retrieve astrological details. Please try again.',
                    errorOccurred: 'An error occurred. Details:',
                    astrologicalDetailsHeader: 'Astrological Details',
                    horoscopeHeader: 'Horoscopes',
                    dailyHoroscopeTitle: 'Daily Horoscope',
                    weeklyHoroscopeTitle: 'Weekly Horoscope',
                    monthlyHoroscopeTitle: 'Monthly Horoscope',
                    yearlyHoroscopeTitle: 'Yearly Horoscope',
                    lifeStagesTitle: 'Life Stages',
                    relationshipsHeader: 'Daily Relationship Insights',
                    userInfoHeader: 'User Details',
                    dateOfBirth: 'Date of Birth',
                    birthPlace: 'Birth Place',
                },
                ne: {
                    mainTitle: 'व्यक्तिगत राशिफल र ज्योतिष',
                    mainSubtitle: 'आफ्नो अद्वितीय ज्योतिषीय अन्तर्दृष्टि प्राप्त गर्न आफ्नो विवरणहरू भर्नुहोस्।',
                    labelLanguage: 'भाषा चयन गर्नुहोस्',
                    labelName: 'पूरा नाम',
                    placeholderName: 'उदाहरण: जोन डो',
                    labelDob: 'जन्म मिति',
                    labelBirthplace: 'जन्म स्थान',
                    placeholderBirthplace: 'उदाहरण: काठमाडौं, नेपाल',
                    submitBtn: 'मेरो राशिफल प्राप्त गर्नुहोस्',
                    pleaseWait: 'कृपया पर्खनुहोस्...',
                    errorTitle: 'त्रुटि',
                    errorMessage: 'कृपया सबै जानकारी भर्नुहोस्।',
                    errorRetrieval: 'ज्योतिषीय विवरण प्राप्त गर्न सकिएन। कृपया फेरि प्रयास गर्नुहोस्।',
                    errorOccurred: 'एक त्रुटि भयो। विवरण:',
                    astrologicalDetailsHeader: 'ज्योतिषीय विवरण',
                    horoscopeHeader: 'राशिफल',
                    dailyHoroscopeTitle: 'दैनिक राशिफल',
                    weeklyHoroscopeTitle: 'साप्ताहिक राशिफल',
                    monthlyHoroscopeTitle: 'मासिक राशिफल',
                    yearlyHoroscopeTitle: 'वार्षिक राशिफल',
                    lifeStagesTitle: 'जीवनका चरणहरू',
                    relationshipsHeader: 'दैनिक सम्बन्धको जानकारी',
                    userInfoHeader: 'प्रयोगकर्ता विवरण',
                    dateOfBirth: 'जन्म मिति',
                    birthPlace: 'जन्म स्थान',
                },
                hi: {
                    mainTitle: 'व्यक्तिगत राशिफल और ज्योतिष',
                    mainSubtitle: 'अपनी अद्वितीय ज्योतिषीय अंतर्दृष्टि प्राप्त करने के लिए अपना विवरण दर्ज करें।',
                    labelLanguage: 'भाषा चुनें',
                    labelName: 'पूरा नाम',
                    placeholderName: 'उदाहरण: जॉन डो',
                    labelDob: 'जन्म तिथि',
                    labelBirthplace: 'जन्म स्थान',
                    placeholderBirthplace: 'उदाहरण: काठमांडू, नेपाल',
                    submitBtn: 'मेरा राशिफल प्राप्त करें',
                    pleaseWait: 'कृपया प्रतीक्षा करें...',
                    errorTitle: 'त्रुटि',
                    errorMessage: 'कृपया सभी विवरण भरें।',
                    errorRetrieval: 'ज्योतिषीय विवरण प्राप्त नहीं हो सका। कृपया पुनः प्रयास करें।',
                    errorOccurred: 'एक त्रुटि हुई। विवरण:',
                    astrologicalDetailsHeader: 'ज्योतिषीय विवरण',
                    horoscopeHeader: 'राशिफल',
                    dailyHoroscopeTitle: 'दैनिक राशिफल',
                    weeklyHoroscopeTitle: 'साप्ताहिक राशिफल',
                    monthlyHoroscopeTitle: 'मासिक राशिफल',
                    yearlyHoroscopeTitle: 'वार्षिक राशिफल',
                    lifeStagesTitle: 'जीवन के चरण',
                    relationshipsHeader: 'दैनिक संबंध अंतर्दृष्टि',
                    userInfoHeader: 'उपयोगकर्ता विवरण',
                    dateOfBirth: 'जन्म तिथि',
                    birthPlace: 'जन्म स्थान',
                }
            };

            // Function to update all text based on selected language
            function updateLanguage(lang) {
                document.getElementById('main-title').textContent = translations[lang].mainTitle;
                document.getElementById('main-subtitle').textContent = translations[lang].mainSubtitle;
                document.getElementById('label-language').textContent = translations[lang].labelLanguage;
                document.getElementById('label-name').textContent = translations[lang].labelName;
                document.getElementById('name').placeholder = translations[lang].placeholderName;
                document.getElementById('label-dob').textContent = translations[lang].labelDob;
                document.getElementById('label-birthplace').textContent = translations[lang].labelBirthplace;
                document.getElementById('birthplace').placeholder = translations[lang].placeholderBirthplace;
                document.getElementById('submit-btn').innerHTML = `<i class="fa-solid fa-magic mr-2"></i> ${translations[lang].submitBtn}`;
                
                document.getElementById('astrological-details-header').textContent = translations[lang].astrologicalDetailsHeader;
                document.getElementById('horoscope-header').textContent = translations[lang].horoscopeHeader;
                document.getElementById('daily-horoscope-title').textContent = translations[lang].dailyHoroscopeTitle;
                document.getElementById('weekly-horoscope-title').textContent = translations[lang].weeklyHoroscopeTitle;
                document.getElementById('monthly-horoscope-title').textContent = translations[lang].monthlyHoroscopeTitle;
                document.getElementById('yearly-horoscope-title').textContent = translations[lang].yearlyHoroscopeTitle;
                document.getElementById('life-stages-title').textContent = translations[lang].lifeStagesTitle;
                document.getElementById('relationships-header').textContent = translations[lang].relationshipsHeader;
                document.getElementById('user-info-header').textContent = translations[lang].userInfoHeader;
            }

            // Load saved user details from local storage
            const savedDetails = localStorage.getItem('horoscopeUserDetails');
            if (savedDetails) {
                const userDetails = JSON.parse(savedDetails);
                document.getElementById('name').value = userDetails.name || '';
                document.getElementById('dob').value = userDetails.dob || '';
                document.getElementById('birthplace').value = userDetails.birthplace || '';
                document.getElementById('language').value = userDetails.language || 'en';
            }
            updateLanguage(languageSelect.value);

            // Accordion functionality
            const accordionHeaders = document.querySelectorAll('.accordion-header');
            accordionHeaders.forEach(header => {
                header.addEventListener('click', () => {
                    const content = document.getElementById(header.dataset.target);
                    const icon = header.querySelector('.fa-chevron-down');
                    
                    const isActive = content.classList.contains('active');

                    // Close all other accordions
                    document.querySelectorAll('.accordion-content').forEach(accContent => {
                        if (accContent !== content) {
                             accContent.classList.remove('active');
                             const otherIcon = accContent.previousElementSibling.querySelector('.fa-chevron-down');
                             otherIcon.classList.remove('rotated-icon');
                        }
                    });

                    // Toggle the clicked accordion
                    content.classList.toggle('active');
                    if (isActive) {
                        icon.classList.remove('rotated-icon');
                    } else {
                        icon.classList.add('rotated-icon');
                    }
                });
            });

            // Set up a custom alert function to replace the browser's alert()
            function showAlert(title, message) {
                alertTitle.textContent = title;
                alertMessage.textContent = message;
                alertModal.classList.remove('hidden');
                alertModal.classList.add('flex');
            }

            alertOkBtn.addEventListener('click', () => {
                alertModal.classList.add('hidden');
                alertModal.classList.remove('flex');
            });

            // Update header and button text when language changes
            languageSelect.addEventListener('change', (e) => {
                updateLanguage(e.target.value);
            });

            form.addEventListener('submit', async (e) => {
                e.preventDefault();

                const name = document.getElementById('name').value;
                const dob = document.getElementById('dob').value;
                const birthplace = document.getElementById('birthplace').value;
                const language = document.getElementById('language').value;

                if (!name || !dob || !birthplace) {
                    showAlert(translations[language].errorTitle, translations[language].errorMessage);
                    return;
                }

                const userDetails = { name, dob, birthplace, language };
                localStorage.setItem('horoscopeUserDetails', JSON.stringify(userDetails));

                loading.classList.remove('hidden');
                resultsDiv.classList.add('hidden');
                submitBtn.disabled = true;
                submitBtn.innerHTML = `<i class="fa-solid fa-magic mr-2"></i> ${translations[language].pleaseWait}`;
                
                // Reset previous results
                const allSections = ['daily-horoscope', 'weekly-horoscope', 'monthly-horoscope', 'yearly-horoscope', 'life-stages', 'relationships', 'astrological-details'];
                allSections.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) {
                        el.innerHTML = '<p>Loading...</p>';
                    }
                });
                
                // Display user info immediately
                displayUserInfo(userDetails, language);

                try {
                    const allData = await getAstrologicalData(userDetails);
                    
                    displayAstrologicalDetails(allData.astrological_details, allData.birthplace_description, language);
                    displayHoroscope('daily', allData.daily_horoscope, language);
                    displayHoroscope('weekly', allData.weekly_horoscope, language);
                    displayHoroscope('monthly', allData.monthly_horoscope, language);
                    displayHoroscope('yearly', allData.yearly_horoscope, language);
                    displayHoroscope('life-stages', allData.life_stages, language);
                    displayHoroscope('relationships', allData.relationships, language);
                    
                    resultsDiv.classList.remove('hidden');
                    document.getElementById('daily-horoscope-content').classList.add('active'); // Open daily section
                } catch (error) {
                    console.error('Error fetching data:', error);
                    showAlert(translations[language].errorTitle, `${translations[language].errorOccurred} ${error.message}`);
                } finally {
                    loading.classList.add('hidden');
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = `<i class="fa-solid fa-magic mr-2"></i> ${translations[language].submitBtn}`;
                }
            });

            async function getAstrologicalData({ name, dob, birthplace, language }) {
                const nakshatraRashiData = `
                    Rashi: मेष (Mesha), नक्षेत्र: अश्विनी (Aswini), भरणी (Bharani), कृत्तिका (Krithika), नामको सुरुको अक्षर: चु, चे, चो, ला, लि, लु, ले, लो, अ, ई, ऊ, ए
                    Rashi: वृष (Vrishabha), नक्षेत्र: रोहिणी (Rohini), मृगशिरा (Mrigashiras), नामको सुरुको अक्षर: ओ, वा, वि, वु, वे, वो, का, कि, कु
                    Rashi: मिथुन (Mithuna), नक्षेत्र: आद्रा (Audra), पुनर्वसु (Punarvasu), नामको सुरुको अक्षर: का, कि, कु, के, को, हा, हि, हु, हे, हो, दा, दी, दु, दे, दो
                    Rashi: कर्कट (Karkata), नक्षेत्र: पुष्य (Pushya), आश्लेषा (Ashlesha), नामको सुरुको अक्षर: हु, हे, हो, डा, डि, डु, डे, डो
                    Rashi: सिंह (Simha), नक्षेत्र: माघ (Magha), पूर्वाफाल्गुनी (Poorva Phalguni), उत्तराफाल्गुनी (Uttara Phalguni), नामको सुरुको अक्षर: मा, मी, मु, मे, मो, टा, टी, टु, टे, टो
                    Rashi: कन्या (Kanya), नक्षेत्र: हस्त (Hastha), चित्रा (Chitra), नामको सुरुको अक्षर: पा, पी, पू, ष, ण, ठ, पे, पो, रा, री, रु, रे, रो, ता, ती, तु, ते, तो
                    Rashi: तुला (Tula), नक्षेत्र: स्वाती (Swati), विशाखा (Visakha), नामको सुरुको अक्षर: रा, री, रु, रे, रो, ता, ती, तु, ते, तो
                    Rashi: वृश्चिक (Vrishchika), नक्षेत्र: अनुराधा (Anuradha), ज्येष्ठा (Jyestha), नामको सुरुको अक्षर: तो, ना, नी, नु, ने, नो, या, यी, यु, ये, यो
                    Rashi: धनु (Dhanus), नक्षेत्र: मूल (Moola), पूर्वाषाढा (Purva Ashadha), उत्तराषाढा (Uttarashada), नामको सुरुको अक्षर: ये, यो, भ, ध, फा, ढा, भे, भो, गा, गी
                    Rashi: मकर (Makara), नक्षेत्र: श्रवण (Sravana), धनिष्ठा (Dhanishta), नामको सुरुको अक्षर: भो, जा, जी, जु, जे, जो, खा, खी, खु, खे, खो, ग, गी
                    Rashi: कुम्भ (Kumbha), नक्षेत्र: शतभिषा (Sathabisham), पूर्वभाद्रपद (Purvabhadra), नामको सुरुको अक्षर: गो, सा, सी, सु, से, सो, दा, दी, दु, दे, दो, चा, ची
                    Rashi: मीन (Meena), नक्षेत्र: उत्तरभाद्रपद (Uttarabhadra), रेवती (Revati), नामको सुरुको अक्षर: दि, दु, थ, झ, ञ, दे, दो, च, चि, द, दी
                `;
                
                const currentDate = new Date().toISOString().slice(0, 10);
                
                const promptText = `
                    Generate a comprehensive JSON object in ${language === 'ne' ? 'Nepali' : (language === 'hi' ? 'Hindi' : 'English')} with the following data points for a person with the name: ${name}, date of birth: ${dob}, and birthplace: ${birthplace}. 
                    Use the provided Rashi and Nakshatra data to inform the astrological readings.
                    The JSON object should have the following string properties:
                    - 'astrological_details': A detailed and elaborate astrological reading including the person's Rashi.
                    - 'birthplace_description': A short paragraph about the provided birthplace.
                    - 'daily_horoscope': A detailed and specific daily horoscope for today's date: ${currentDate}.
                    - 'weekly_horoscope': An elaborated paragraph for their horoscope for the coming week.
                    - 'monthly_horoscope': An elaborated paragraph for their horoscope for the coming month.
                    - 'yearly_horoscope': A comprehensive and detailed paragraph for their horoscope for the coming year.
                    - 'life_stages': A detailed and elaborate paragraph about their horoscope for different life stages: youth, adulthood, and old age.
                    - 'relationships': A detailed and elaborate paragraph about how their daily relationships will be with family (dad, mom, siblings) and spouse/kids.
                `;

                const schema = {
                    type: "OBJECT",
                    properties: {
                        "astrological_details": { "type": "STRING" },
                        "birthplace_description": { "type": "STRING" },
                        "daily_horoscope": { "type": "STRING" },
                        "weekly_horoscope": { "type": "STRING" },
                        "monthly_horoscope": { "type": "STRING" },
                        "yearly_horoscope": { "type": "STRING" },
                        "life_stages": { "type": "STRING" },
                        "relationships": { "type": "STRING" }
                    },
                    required: [
                        "astrological_details", "birthplace_description", "daily_horoscope",
                        "weekly_horoscope", "monthly_horoscope", "yearly_horoscope",
                        "life_stages", "relationships"
                    ]
                };

                const chatHistory = [{ role: "user", parts: [{ text: promptText + nakshatraRashiData }] }];
                const payload = {
                    contents: chatHistory,
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: schema
                    }
                };
                
                const apiKey = "AIzaSyB7XFRloLVbmnXUjU5mfcud5i-F2Ep6XVg";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

                let retryCount = 0;
                const maxRetries = 5;
                const initialDelay = 1000;

                while (retryCount < maxRetries) {
                    try {
                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (!response.ok) {
                            if (response.status === 429) {
                                const delay = initialDelay * Math.pow(2, retryCount);
                                console.warn(`API rate limit exceeded. Retrying in ${delay}ms...`);
                                await new Promise(resolve => setTimeout(resolve, delay));
                                retryCount++;
                                continue;
                            } else {
                                throw new Error(`API returned status code: ${response.status}`);
                            }
                        }

                        const result = await response.json();
                        if (result.candidates && result.candidates.length > 0 &&
                            result.candidates[0].content && result.candidates[0].content.parts &&
                            result.candidates[0].content.parts.length > 0) {
                            const jsonText = result.candidates[0].content.parts[0].text;
                            try {
                                const parsedJson = JSON.parse(jsonText);
                                return parsedJson;
                            } catch (parseError) {
                                console.error('Failed to parse JSON:', parseError);
                                const jsonMatch = jsonText.match(/\{[\s\S]*\}/);
                                if (jsonMatch) {
                                    return JSON.parse(jsonMatch[0]);
                                }
                                throw new Error('Invalid JSON format received from API.');
                            }
                        } else {
                            throw new Error('Unexpected API response structure or no content.');
                        }
                    } catch (error) {
                        console.error('Fetch error:', error);
                        throw error;
                    }
                }
                throw new Error('Max API retries exceeded.');
            }
            
            function displayUserInfo(userDetails, language) {
                const { dob, birthplace } = userDetails;
                userInfoDiv.innerHTML = `
                    <div class="mb-2">
                        <p class="text-sm font-medium text-gray-700">${translations[language].dateOfBirth}:</p>
                        <p class="text-gray-600">${dob}</p>
                    </div>
                    <div>
                        <p class="text-sm font-medium text-gray-700">${translations[language].birthPlace}:</p>
                        <p class="text-gray-600">${birthplace}</p>
                    </div>
                `;
            }

            function displayAstrologicalDetails(astrological_details, birthplace_description, language) {
                document.getElementById('astrological-details').innerHTML = `
                    <p class="text-gray-600 mb-4">${astrological_details}</p>
                    ${birthplace_description ? `<p class="text-gray-600">${birthplace_description}</p>` : ''}
                `;
            }

            function displayHoroscope(type, content, language) {
                if (type === 'relationships') {
                    const header = document.getElementById('relationships-header');
                    if (header) {
                        header.textContent = translations[language].relationshipsHeader;
                    }
                    const contentDiv = document.getElementById('relationships');
                    if (contentDiv) {
                        contentDiv.innerHTML = `<p class="text-gray-600">${content}</p>`;
                    }
                } else {
                    const headerSpan = document.getElementById(`${type}-horoscope-title`);
                    if (headerSpan) {
                         // The key names match the translation keys with 'HoroscopeTitle' appended.
                         const translationKey = type.split('-').map((word, index) => index === 0 ? word : word.charAt(0).toUpperCase() + word.slice(1)).join('') + 'HoroscopeTitle';
                         headerSpan.textContent = translations[language][translationKey];
                    }
                    const contentDiv = document.getElementById(`${type}-horoscope`);
                    if (contentDiv) {
                        contentDiv.innerHTML = `<p class="text-gray-600">${content}</p>`;
                    }
                }
            }
        });
    </script>
</body>
</html>
