<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personalized Horoscope</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #3b82f6;
            border-radius: 50%;
            width: 3rem;
            height: 3rem;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        .accordion-content.active {
            max-height: 1000px; /* A large number to allow for content expansion */
            transition: max-height 0.5s ease-in;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <div class="container mx-auto p-6 bg-white rounded-xl shadow-lg w-full max-w-4xl">
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-800 mb-2">Personalized Horoscope & Astrology</h1>
            <p class="text-gray-600">Enter your details to get your unique astrological insights.</p>
        </div>

        <!-- Input Form -->
        <form id="horoscope-form" class="space-y-6">
            <!-- Language Selection -->
            <div>
                <label for="language" class="block text-sm font-medium text-gray-700">Select Language</label>
                <select id="language" name="language" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md shadow-sm">
                    <option value="en">English</option>
                    <option value="ne">Nepali</option>
                </select>
            </div>

            <!-- Name Input -->
            <div>
                <label for="name" class="block text-sm font-medium text-gray-700">Full Name</label>
                <input type="text" id="name" name="name" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="e.g., John Doe">
            </div>

            <!-- Date of Birth Input -->
            <div>
                <label for="dob" class="block text-sm font-medium text-gray-700">Date of Birth</label>
                <input type="date" id="dob" name="dob" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
            </div>

            <!-- Birth Place Input -->
            <div>
                <label for="birthplace" class="block text-sm font-medium text-gray-700">Birth Place</label>
                <input type="text" id="birthplace" name="birthplace" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="e.g., Kathmandu, Nepal">
            </div>

            <!-- Submit Button -->
            <div>
                <button type="submit" id="submit-btn" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-all duration-200 ease-in-out">
                    <i class="fa-solid fa-magic mr-2"></i> Get My Horoscope
                </button>
            </div>
        </form>

        <!-- Loading Indicator -->
        <div id="loading" class="hidden flex justify-center items-center mt-8">
            <div class="loading-spinner"></div>
        </div>
        
        <!-- Results Section with Accordion -->
        <div id="results" class="hidden mt-8 space-y-4">

            <!-- Astrological Details Section -->
            <div id="astrological-details-card" class="bg-gray-50 p-6 rounded-lg shadow-sm">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">Astrological Details</h2>
                <div id="astrological-details"></div>
            </div>

            <!-- Horoscope Accordion -->
            <div class="bg-white rounded-lg shadow-sm overflow-hidden">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4 p-4">Horoscopes</h2>
                
                <!-- Daily Horoscope Accordion Item -->
                <div class="border-t border-gray-200">
                    <button class="accordion-header w-full text-left p-4 flex justify-between items-center bg-gray-100 hover:bg-gray-200 transition-colors duration-200" data-target="daily-horoscope-content">
                        <span class="text-lg font-medium text-gray-700">Daily Horoscope</span>
                        <i class="fas fa-chevron-down text-gray-500 transition-transform duration-200"></i>
                    </button>
                    <div id="daily-horoscope-content" class="accordion-content p-4 bg-white">
                        <div id="daily-horoscope" class="text-gray-600">
                            <p>Loading...</p>
                        </div>
                    </div>
                </div>

                <!-- Weekly Horoscope Accordion Item -->
                <div class="border-t border-gray-200">
                    <button class="accordion-header w-full text-left p-4 flex justify-between items-center bg-gray-100 hover:bg-gray-200 transition-colors duration-200" data-target="weekly-horoscope-content">
                        <span class="text-lg font-medium text-gray-700">Weekly Horoscope</span>
                        <i class="fas fa-chevron-down text-gray-500 transition-transform duration-200"></i>
                    </button>
                    <div id="weekly-horoscope-content" class="accordion-content p-4 bg-white">
                        <div id="weekly-horoscope" class="text-gray-600">
                            <p>Loading...</p>
                        </div>
                    </div>
                </div>

                <!-- Monthly Horoscope Accordion Item -->
                <div class="border-t border-gray-200">
                    <button class="accordion-header w-full text-left p-4 flex justify-between items-center bg-gray-100 hover:bg-gray-200 transition-colors duration-200" data-target="monthly-horoscope-content">
                        <span class="text-lg font-medium text-gray-700">Monthly Horoscope</span>
                        <i class="fas fa-chevron-down text-gray-500 transition-transform duration-200"></i>
                    </button>
                    <div id="monthly-horoscope-content" class="accordion-content p-4 bg-white">
                        <div id="monthly-horoscope" class="text-gray-600">
                            <p>Loading...</p>
                        </div>
                    </div>
                </div>

                <!-- Yearly Horoscope Accordion Item -->
                <div class="border-t border-gray-200">
                    <button class="accordion-header w-full text-left p-4 flex justify-between items-center bg-gray-100 hover:bg-gray-200 transition-colors duration-200" data-target="yearly-horoscope-content">
                        <span class="text-lg font-medium text-gray-700">Yearly Horoscope</span>
                        <i class="fas fa-chevron-down text-gray-500 transition-transform duration-200"></i>
                    </button>
                    <div id="yearly-horoscope-content" class="accordion-content p-4 bg-white">
                        <div id="yearly-horoscope" class="text-gray-600">
                            <p>Loading...</p>
                        </div>
                    </div>
                </div>

                <!-- Life Stages Accordion Item -->
                <div class="border-t border-gray-200">
                    <button class="accordion-header w-full text-left p-4 flex justify-between items-center bg-gray-100 hover:bg-gray-200 transition-colors duration-200" data-target="life-stages-content">
                        <span class="text-lg font-medium text-gray-700">Life Stages</span>
                        <i class="fas fa-chevron-down text-gray-500 transition-transform duration-200"></i>
                    </button>
                    <div id="life-stages-content" class="accordion-content p-4 bg-white">
                        <div id="life-stages" class="text-gray-600">
                            <p>Loading...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Relationships Section -->
            <div id="relationships-card" class="bg-gray-50 p-6 rounded-lg shadow-sm">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">Daily Relationship Insights</h2>
                <div id="relationships"></div>
            </div>
        </div>

        <!-- Custom Alert/Error Modal -->
        <div id="alert-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden flex items-center justify-center p-4">
            <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm">
                <h3 class="text-lg font-medium text-gray-900" id="alert-title"></h3>
                <div class="mt-2 text-sm text-gray-500" id="alert-message"></div>
                <div class="mt-4 flex justify-end">
                    <button type="button" id="alert-ok-btn" class="inline-flex justify-center rounded-md border border-transparent bg-blue-100 px-4 py-2 text-sm font-medium text-blue-900 hover:bg-blue-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                        OK
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const form = document.getElementById('horoscope-form');
            const submitBtn = document.getElementById('submit-btn');
            const loading = document.getElementById('loading');
            const resultsDiv = document.getElementById('results');
            const alertModal = document.getElementById('alert-modal');
            const alertTitle = document.getElementById('alert-title');
            const alertMessage = document.getElementById('alert-message');
            const alertOkBtn = document.getElementById('alert-ok-btn');

            // Load saved user details from local storage
            const savedDetails = localStorage.getItem('horoscopeUserDetails');
            if (savedDetails) {
                const userDetails = JSON.parse(savedDetails);
                document.getElementById('name').value = userDetails.name || '';
                document.getElementById('dob').value = userDetails.dob || '';
                document.getElementById('birthplace').value = userDetails.birthplace || '';
                document.getElementById('language').value = userDetails.language || 'en';
            }

            // Accordion functionality
            const accordionHeaders = document.querySelectorAll('.accordion-header');
            accordionHeaders.forEach(header => {
                header.addEventListener('click', () => {
                    const content = document.getElementById(header.dataset.target);
                    const icon = header.querySelector('i');
                    content.classList.toggle('active');
                    icon.classList.toggle('fa-chevron-down');
                    icon.classList.toggle('fa-chevron-up');
                });
            });

            // Set up a custom alert function to replace the browser's alert()
            function showAlert(title, message) {
                alertTitle.textContent = title;
                alertMessage.textContent = message;
                alertModal.classList.remove('hidden');
                alertModal.classList.add('flex');
            }

            alertOkBtn.addEventListener('click', () => {
                alertModal.classList.add('hidden');
                alertModal.classList.remove('flex');
            });

            form.addEventListener('submit', async (e) => {
                e.preventDefault();

                const name = document.getElementById('name').value;
                const dob = document.getElementById('dob').value;
                const birthplace = document.getElementById('birthplace').value;
                const language = document.getElementById('language').value;

                if (!name || !dob || !birthplace) {
                    const title = language === 'ne' ? 'त्रुटि' : 'Error';
                    const message = language === 'ne' ? 'कृपया सबै जानकारी भर्नुहोस्।' : 'Please fill in all the details.';
                    showAlert(title, message);
                    return;
                }

                const userDetails = { name, dob, birthplace, language };
                localStorage.setItem('horoscopeUserDetails', JSON.stringify(userDetails));

                loading.classList.remove('hidden');
                resultsDiv.classList.add('hidden');
                submitBtn.disabled = true;
                submitBtn.textContent = (language === 'ne' ? 'कृपया पर्खनुहोस्...' : 'Please wait...');
                
                // Reset previous results
                const allHoroscopes = ['daily', 'weekly', 'monthly', 'yearly', 'life-stages', 'relationships'];
                allHoroscopes.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) {
                        el.innerHTML = '<p>Loading...</p>';
                    }
                });
                document.getElementById('astrological-details').innerHTML = '<p>Loading...</p>';

                try {
                    // First, get basic astrological details and daily horoscope
                    const dailyData = await getAstrologicalData({ 
                        name, 
                        dob, 
                        birthplace, 
                        language, 
                        type: 'daily' 
                    });
                    if (dailyData) {
                        displayAstrologicalDetails(dailyData, language);
                        displayHoroscope('daily', dailyData.daily_horoscope, language);
                        resultsDiv.classList.remove('hidden');
                        document.getElementById('daily-horoscope-content').classList.add('active'); // Open daily section
                        
                        // Then, fetch other horoscopes in the background
                        getAstrologicalData({ name, dob, birthplace, language, type: 'weekly' })
                            .then(data => displayHoroscope('weekly', data.weekly_horoscope, language))
                            .catch(error => console.error('Weekly horoscope fetch failed:', error));

                        getAstrologicalData({ name, dob, birthplace, language, type: 'monthly' })
                            .then(data => displayHoroscope('monthly', data.monthly_horoscope, language))
                            .catch(error => console.error('Monthly horoscope fetch failed:', error));

                        getAstrologicalData({ name, dob, birthplace, language, type: 'yearly' })
                            .then(data => displayHoroscope('yearly', data.yearly_horoscope, language))
                            .catch(error => console.error('Yearly horoscope fetch failed:', error));
                        
                        getAstrologicalData({ name, dob, birthplace, language, type: 'life-stages' })
                            .then(data => displayHoroscope('life-stages', data.life_stages, language))
                            .catch(error => console.error('Life stages fetch failed:', error));

                        getAstrologicalData({ name, dob, birthplace, language, type: 'relationships' })
                            .then(data => displayHoroscope('relationships', data.relationships, language))
                            .catch(error => console.error('Relationships fetch failed:', error));

                    } else {
                        showAlert('Error', language === 'ne' ? 'ज्योतिषीय विवरण प्राप्त गर्न सकिएन। कृपया फेरि प्रयास गर्नुहोस्।' : 'Could not retrieve astrological details. Please try again.');
                    }
                } catch (error) {
                    console.error('Error fetching data:', error);
                    const title = language === 'ne' ? 'त्रुटि' : 'Error';
                    const message = language === 'ne' ? `एक त्रुटि भयो। विवरण: ${error.message}` : `An error occurred. Details: ${error.message}`;
                    showAlert(title, message);
                } finally {
                    loading.classList.add('hidden');
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = `<i class="fa-solid fa-magic mr-2"></i> ${language === 'ne' ? 'मेरो राशिफल प्राप्त गर्नुहोस्' : 'Get My Horoscope'}`;
                }
            });

            async function getAstrologicalData({ name, dob, birthplace, language, type }) {
                const nakshatraRashiData = `
                    Rashi: Mesha, Nakshatras: Aswini (Awasthi), Bharani, Krithika (Karthikai), Initial letters: Chu, Che, Cho, La, Li, Lu, Le, Lo, A, Ee, U, E
                    Rashi: Vrishabha, Nakshatras: Rohini, Mrigashiras (Magave), Initial letters: O, BA, BI, Bu, Be, Bo, Vo, Ka, Ki, Ku
                    Rashi: Mithuna, Nakshatras: Audra (Thiruvadhi), Punarvasu (Punartham), Initial letters: Gha, Ng, Chha, Ke, Ko, Ha, Hi, Hu
                    Rashi: Karkata, Nakshatras: Pushyami (Pooyaram), Ashlesha (Ayilyam), Initial letters: Hu, He, Ho, Da, Dee, Doo, De, Do
                    Rashi: Simha, Nakshatras: Makha (Magha), Poorva Phalguni (Pooram), Uttara Phalguni (Uttaram), Initial letters: Ma, Me, Mo, Ta, Ti, Tu, Te, To, Pa, Pe, Po
                    Rashi: Kanya, Nakshatras: Hastha (Atham), Chitra (Chithira), Initial letters: Pu, Poo, Sha, Pe, Po, Ra
                    Rashi: Tula, Nakshatras: Swati (Chothy), Visakha (Visakam), Initial letters: Ru, Re, Ro, Ta, Te, Tu, Te
                    Rashi: Vrishchika, Nakshatras: Anuradha (Anizham), Jyeshta (Triketta), Initial letters: Na, Nee, Nu, Ne, No, Ya, Ye, Yu
                    Rashi: Dhanus, Nakshatras: Moola (Moolam), Purva Ashadha (Pooradam), Uttarashada, Initial letters: Yo, Ye, Bhe, Bho, Ga, Bhu, Dha, Pha, Bha
                    Rashi: Makara, Nakshatras: Sravana (Thiruvonam), Dhanishta (Avittam), Initial letters: Khe, Khob, Ga, Gi, Gu, Ge, Go, Ga, Gi
                    Rashi: Kumbha, Nakshatras: Sathabisham (Chathayam), Purvabhadra (Poorvabhadra), Initial letters: Go, Sa, Si, Su, Se, So, Da, Di, Du
                    Rashi: Meena, Nakshatras: Uttarabhadra (Uthrittathi), Revati (Revati), Initial letters: Di, Du, Tha, Jha, Na, De, Do, Cha, Chi
                `;

                let promptText = '';
                const basePrompt = `Generate a detailed and elaborate astrological reading in ${language === 'ne' ? 'Nepali' : 'English'} for a person with the following information. Use the provided Nakshatra and Rashi data to determine the person's astrological sign based on their date of birth, and generate the horoscope accordingly. You can include the Rashi name in the final output. The provided data is: ${nakshatraRashiData}. Do not include any text outside of the JSON object.
                Name: ${name}.
                Date of Birth: ${dob}.
                Birth Place: ${birthplace}.`;

                switch (type) {
                    case 'daily':
                        promptText = `${basePrompt}
                        The JSON object should have the following keys: "astrological_details" (a detailed paragraph about their zodiac sign and planetary influences) and "daily_horoscope" (a detailed and specific daily horoscope for today).`;
                        break;
                    case 'weekly':
                        promptText = `${basePrompt}
                        The JSON object should have the following key: "weekly_horoscope" (an elaborated paragraph for their horoscope for the coming week).`;
                        break;
                    case 'monthly':
                        promptText = `${basePrompt}
                        The JSON object should have the following key: "monthly_horoscope" (an elaborated paragraph for their horoscope for the coming month).`;
                        break;
                    case 'yearly':
                        promptText = `${basePrompt}
                        The JSON object should have the following key: "yearly_horoscope" (a comprehensive and detailed paragraph for their horoscope for the coming year).`;
                        break;
                    case 'life-stages':
                        promptText = `${basePrompt}
                        The JSON object should have the following key: "life_stages" (a detailed and elaborate paragraph about their horoscope for different life stages: youth, adulthood, and old age).`;
                        break;
                    case 'relationships':
                        promptText = `${basePrompt}
                        The JSON object should have the following key: "relationships" (a detailed and elaborate paragraph about how their daily relationships will be with family (dad, mom, siblings) and spouse/kids).`;
                        break;
                }
                
                const chatHistory = [{ role: "user", parts: [{ text: promptText }] }];
                const payload = {
                    contents: chatHistory,
                    generationConfig: {
                        responseMimeType: "application/json"
                    }
                };
                
                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

                let retryCount = 0;
                const maxRetries = 5;
                const initialDelay = 1000;

                while (retryCount < maxRetries) {
                    try {
                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (!response.ok) {
                            if (response.status === 429) {
                                const delay = initialDelay * Math.pow(2, retryCount);
                                console.warn(`API rate limit exceeded. Retrying in ${delay}ms...`);
                                await new Promise(resolve => setTimeout(resolve, delay));
                                retryCount++;
                                continue;
                            } else {
                                throw new Error(`API returned status code: ${response.status}`);
                            }
                        }

                        const result = await response.json();
                        if (result.candidates && result.candidates.length > 0 &&
                            result.candidates[0].content && result.candidates[0].content.parts &&
                            result.candidates[0].content.parts.length > 0) {
                            const jsonText = result.candidates[0].content.parts[0].text;
                            try {
                                return JSON.parse(jsonText);
                            } catch (parseError) {
                                console.error('Failed to parse JSON:', parseError);
                                const jsonMatch = jsonText.match(/\{[\s\S]*\}/);
                                if (jsonMatch) {
                                    return JSON.parse(jsonMatch[0]);
                                }
                                throw new Error('Invalid JSON format received from API.');
                            }
                        } else {
                            throw new Error('Unexpected API response structure or no content.');
                        }
                    } catch (error) {
                        console.error('Fetch error:', error);
                        throw error;
                    }
                }
                throw new Error('Max API retries exceeded.');
            }

            function displayAstrologicalDetails(data, language) {
                const labels = {
                    en: { astrologicalDetails: 'Astrological Details' },
                    ne: { astrologicalDetails: 'ज्योतिषीय विवरण' }
                };
                document.getElementById('astrological-details-card').querySelector('h2').textContent = labels[language].astrologicalDetails;
                document.getElementById('astrological-details').innerHTML = `<p class="text-gray-600">${data.astrological_details}</p>`;
            }

            function displayHoroscope(type, content, language) {
                const labels = {
                    en: {
                        'daily': 'Daily Horoscope', 'weekly': 'Weekly Horoscope', 'monthly': 'Monthly Horoscope',
                        'yearly': 'Yearly Horoscope', 'life-stages': 'Life Stages', 'relationships': 'Daily Relationship Insights'
                    },
                    ne: {
                        'daily': 'दैनिक राशिफल', 'weekly': 'साप्ताहिक राशिफल', 'monthly': 'मासिक राशिफल',
                        'yearly': 'वार्षिक राशिफल', 'life-stages': 'जीवनका चरणहरू', 'relationships': 'दैनिक सम्बन्धको जानकारी'
                    }
                };

                // Update the section header
                if (type === 'relationships') {
                    const cardHeader = document.getElementById('relationships-card').querySelector('h2');
                    cardHeader.textContent = labels[language][type];
                    document.getElementById('relationships').innerHTML = `<p class="text-gray-600">${content}</p>`;
                } else {
                    const headerButton = document.querySelector(`[data-target="${type}-horoscope-content"]`);
                    const headerSpan = headerButton.querySelector('span');
                    headerSpan.textContent = labels[language][type];
                    document.getElementById(`${type}-horoscope`).innerHTML = `<p class="text-gray-600">${content}</p>`;
                }
            }
        });
    </script>
</body>
</html>
