<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Astrology Tool</title>
    <!--
        This script tag loads Tailwind CSS, a utility-first CSS framework.
        We use it for all the styling (colors, layout, spacing, etc.).
        This is a common way to quickly add modern styling to a web page.
    -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!--
        This script loads Lucide Icons, which are a lightweight and modern icon set.
        We use icons for the globe, calendar, clock, and map-pin to make the form more visually appealing.
    -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            /* Sets the default font for the entire page */
            font-family: 'Inter', sans-serif;
        }
        /* Defines the keyframes for the "spin" animation used for the loading spinner */
        @keyframes spin {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }
        /* Applies the spin animation with a fast speed to an element with this class */
        .animate-spin-fast {
            animation: spin 0.7s linear infinite;
        }
    </style>
</head>
<body class="bg-gray-900 text-white flex flex-col items-center justify-center min-h-screen p-4">
    <!--
        This is the main container for the app.
        It's styled with a dark background, rounded corners, shadow, and centered on the page.
    -->
    <div class="bg-gray-800 shadow-2xl rounded-xl p-8 max-w-lg w-full transform transition-all duration-300 hover:scale-105">
        <!-- Main heading for the app -->
        <h1 class="text-4xl font-bold text-center mb-6 text-yellow-300">Astrology Tool</h1>
        <!-- A short descriptive paragraph -->
        <p class="text-center text-gray-400 mb-8">Enter your birth details to discover your astrological chart.</p>

        <!--
            The main form for user input.
            It has an ID for easy access in JavaScript and uses Tailwind classes for spacing.
        -->
        <form id="astrology-form" class="space-y-6">
             <!-- Language selection dropdown -->
            <div class="relative">
                <label for="language" class="block text-sm font-medium text-gray-400 mb-2">Language</label>
                <div class="relative">
                    <!-- Globe icon for the language dropdown, styled with Lucide -->
                    <i data-lucide="globe" class="absolute left-3 top-1/2 -translate-y-1/2 text-yellow-400" size="20"></i>
                    <select
                        id="language"
                        class="w-full pl-10 pr-4 py-3 bg-gray-700 text-white rounded-lg border border-gray-600 focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500 transition-colors duration-200"
                    >
                        <option value="en">English</option>
                        <option value="ne">नेपाली (Nepali)</option>
                    </select>
                </div>
            </div>
            <!-- Person Name input field -->
            <div class="relative">
                <label for="person-name" class="block text-sm font-medium text-gray-400 mb-2">Your Name</label>
                <input
                    type="text"
                    id="person-name"
                    placeholder="e.g., John Doe"
                    required
                    class="w-full pl-4 pr-4 py-3 bg-gray-700 text-white rounded-lg border border-gray-600 focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500 transition-colors duration-200"
                />
            </div>
            <!-- Date of Birth input field -->
            <div class="relative">
                <label for="birth-date" class="block text-sm font-medium text-gray-400 mb-2">Date of Birth</label>
                <div class="relative">
                    <!-- Calendar icon -->
                    <i data-lucide="calendar" class="absolute left-3 top-1/2 -translate-y-1/2 text-yellow-400" size="20"></i>
                    <input
                        type="date"
                        id="birth-date"
                        required
                        class="w-full pl-10 pr-4 py-3 bg-gray-700 text-white rounded-lg border border-gray-600 focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500 transition-colors duration-200"
                    />
                </div>
            </div>
            <!-- Time of Birth input field -->
            <div class="relative">
                <label for="birth-time" class="block text-sm font-medium text-gray-400 mb-2">Time of Birth</label>
                <div class="relative">
                    <!-- Clock icon -->
                    <i data-lucide="clock" class="absolute left-3 top-1/2 -translate-y-1/2 text-yellow-400" size="20"></i>
                    <input
                        type="time"
                        id="birth-time"
                        required
                        class="w-full pl-10 pr-4 py-3 bg-gray-700 text-white rounded-lg border border-gray-600 focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500 transition-colors duration-200"
                    />
                </div>
            </div>
            <!-- City/Location input field -->
            <div class="relative">
                <label for="birth-location" class="block text-sm font-medium text-gray-400 mb-2">City/Location</label>
                <div class="relative">
                    <!-- Map pin icon -->
                    <i data-lucide="map-pin" class="absolute left-3 top-1/2 -translate-y-1/2 text-yellow-400" size="20"></i>
                    <input
                        type="text"
                        id="birth-location"
                        placeholder="e.g., New York, NY"
                        required
                        class="w-full pl-10 pr-4 py-3 bg-gray-700 text-white rounded-lg border border-gray-600 focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500 transition-colors duration-200"
                    />
                </div>
            </div>
            <!-- Submit button to trigger the astrology calculation -->
            <button
                type="submit"
                id="submit-btn"
                class="w-full flex items-center justify-center space-x-2 py-3 px-6 bg-yellow-500 text-gray-900 font-bold rounded-lg shadow-md hover:bg-yellow-400 focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:ring-offset-2 focus:ring-offset-gray-900 transition-all duration-300 transform hover:scale-105"
            >
                <!-- Search icon for the button -->
                <i data-lucide="search" size="20" class="search-icon"></i>
                <span id="button-text">Get My Astrology Details</span>
            </button>
        </form>

        <!--
            This container will hold the results after the form is submitted.
            It is initially hidden with the 'hidden' class.
        -->
        <div id="results-container" class="mt-8 p-6 bg-gray-900 rounded-xl shadow-inner border border-gray-700 hidden">
            <!-- Results will be dynamically inserted here by the JavaScript code -->
        </div>
    </div>

    <!--
        ========================================
        JavaScript section starts here
        ========================================
    -->
    <script>
        // Initializes Lucide icons, so they are rendered as SVGs on the page.
        lucide.createIcons();

        // Fetches all the necessary HTML elements using their unique IDs.
        // This makes it easy to manipulate them later in the code.
        const form = document.getElementById('astrology-form');
        const languageSelect = document.getElementById('language');
        const personNameInput = document.getElementById('person-name');
        const birthDateInput = document.getElementById('birth-date');
        const birthTimeInput = document.getElementById('birth-time');
        const birthLocationInput = document.getElementById('birth-location');
        const submitBtn = document.getElementById('submit-btn');
        const buttonText = document.getElementById('button-text');
        const resultsContainer = document.getElementById('results-container');

        // This object stores all the text strings for the app in different languages.
        // This makes the app easily translatable by simply adding more language keys.
        const translations = {
            en: {
                button: 'Get My Astrology Details',
                title: 'Your Astrological Profile',
                hello: 'Hello',
                sunSign: 'Sun Sign:',
                moonSign: 'Moon Sign:',
                ascendant: 'Ascendant:',
                houseDetails: 'House Details:',
                planetPositions: 'Planet Positions:',
                monthlyRashifal: 'Monthly Rashifal (Horoscope):',
                annualRashifal: 'Annual Rashifal (Horoscope):'
            },
            ne: {
                button: 'मेरो ज्योतिष विवरण प्राप्त गर्नुहोस्',
                title: 'तपाईको ज्योतिषीय प्रोफाइल',
                hello: 'नमस्ते',
                sunSign: 'सूर्य राशि:',
                moonSign: 'चन्द्र राशि:',
                ascendant: 'लग्न:',
                houseDetails: 'घरको विवरण:',
                planetPositions: 'ग्रहको स्थिति:',
                monthlyRashifal: 'मासिक राशिफल:',
                annualRashifal: 'वार्षिक राशिफल:'
            }
        };
        
        // Function to update the text on the submit button based on the selected language.
        const updateButtonText = () => {
            buttonText.textContent = translations[languageSelect.value].button;
        };

        // This event listener waits for the language dropdown value to change.
        // When it changes, the updateButtonText function is called.
        languageSelect.addEventListener('change', updateButtonText);
        updateButtonText(); // Call the function once when the page loads to set the initial text.

        /**
         * Fetches data from the API with a retry mechanism and exponential backoff.
         * This improves reliability in case of transient network issues or API throttling.
         * @param {string} apiUrl The URL of the API endpoint.
         * @param {object} payload The request body payload.
         * @param {number} retries The maximum number of retries.
         * @returns {Promise<Response>} A promise that resolves with the fetch response.
         */
        const fetchWithRetry = async (apiUrl, payload, retries = 5) => {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    if (response.ok) {
                        return response;
                    } else if (response.status >= 500) {
                        // Server error, retry after a delay
                        const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                        console.log(`API call failed with status ${response.status}. Retrying in ${delay}ms...`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                    } else {
                        // Client error (4xx), do not retry
                        console.error(`API call failed with status ${response.status}. Not retrying.`);
                        return response;
                    }
                } catch (error) {
                    // Network error, retry after a delay
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                    console.error(`Network error during API call. Retrying in ${delay}ms...`, error);
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
            throw new Error('API request failed after multiple retries.');
        };

        // This is the main function that runs when the form is submitted.
        form.addEventListener('submit', async (e) => {
            // e.preventDefault() stops the form from reloading the page,
            // which is the default browser behavior.
            e.preventDefault();

            // Start of the loading state
            // ===================================

            // Disable the button to prevent multiple submissions.
            submitBtn.disabled = true;
            // Clear the button text.
            buttonText.textContent = '';
            // Insert the SVG code for the loading spinner into the button.
            submitBtn.innerHTML = '<svg class="animate-spin-fast h-5 w-5 text-gray-900" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>';
            // Hide the results container from the previous submission, if any.
            resultsContainer.classList.add('hidden');

            // Get the values from the form inputs.
            const personName = personNameInput.value;
            const birthDate = birthDateInput.value;
            const birthTime = birthTimeInput.value;
            const birthLocation = birthLocationInput.value;
            const language = languageSelect.value;
            
            console.log('Fetching astrological details for:', { personName, birthDate, birthTime, birthLocation, language });

            try {
                // Gemini API Call for Dynamic Forecast
                // ===================================
                const t = translations[language];
                // The prompt now explicitly asks for a JSON object and nothing else,
                // so we don't need the generationConfig.responseMimeType property.
                const prompt = `Act as an expert astrologer. Generate a detailed and helpful astrology forecast for a person with the following details: Name: ${personName}, Date of Birth: ${birthDate}, Time of Birth: ${birthTime}, Birth Location: ${birthLocation}. The text for each property must be in ${language}. Ensure the "planetPositions" property uses the degree symbol '°' correctly.`;
                
                const chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
                const payload = {
                    contents: chatHistory,
                    generationConfig: {
                        // We are now explicitly requesting a JSON response with a defined schema.
                        // This is a much more reliable way to ensure the response is parsable.
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: "OBJECT",
                            properties: {
                                sunSign: { type: "STRING" },
                                moonSign: { type: "STRING" },
                                ascendant: { type: "STRING" },
                                houseDetails: { type: "STRING" },
                                planetPositions: { type: "STRING" },
                                monthlyRashifal: { type: "STRING" },
                                annualRashifal: { type: "STRING" }
                            }
                        }
                    }
                 };
                
                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                
                const response = await fetchWithRetry(apiUrl, payload);
                const result = await response.json();
                
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                        try {
                            const details = JSON.parse(result.candidates[0].content.parts[0].text);
                            displayResults(details, language);
                        } catch (jsonError) {
                            console.error('Failed to parse JSON from API response:', jsonError, result.candidates[0].content.parts[0].text);
                            resultsContainer.classList.remove('hidden');
                            resultsContainer.innerHTML = `<p class="text-red-400 text-center">Sorry, I received an invalid response from the server. Please try again. The raw response was: <pre>${result.candidates[0].content.parts[0].text}</pre></p>`;
                        }
                } else {
                    console.error('API response structure is unexpected or content is missing', result);
                    resultsContainer.classList.remove('hidden');
                    resultsContainer.innerHTML = `<p class="text-red-400 text-center">Sorry, I couldn't generate a forecast. The server responded with an empty or invalid result. Please try again.</p>`;
                }
            } catch (error) {
                // If a network error or other unhandled error occurs during the "API call", this block will run.
                console.error('Error fetching astrology details:', error);
                // Make the results container visible to show the error.
                resultsContainer.classList.remove('hidden');
                resultsContainer.innerHTML = `<p class="text-red-400 text-center">An error occurred. Please try again. Check your browser console for more details.</p>`;
            } finally {
                // End of the loading state
                // ===================================

                // Re-enable the button.
                submitBtn.disabled = false;
                // Update the button text to the correct language.
                updateButtonText();
                // Replace the spinner SVG with the original search icon.
                submitBtn.innerHTML = `<i data-lucide="search" size="20" class="search-icon"></i><span id="button-text">${translations[language].button}</span>`;
                // Re-render the icons to make sure the search icon appears.
                lucide.createIcons();
            }
        });

        // This function takes the astrological data and the language,
        // then generates the HTML to display the results in the results container.
        function displayResults(details, language) {
            const t = translations[language]; // Gets the correct translation object
            resultsContainer.classList.remove('hidden'); // Makes the results container visible
            // Sets the inner HTML of the results container using a template literal.
            // This allows us to easily insert variables like `t.title` and `details.sunSign`.
            resultsContainer.innerHTML = `
                <h2 class="text-2xl font-bold mb-4 text-center text-yellow-300">${t.title}</h2>
                <div class="space-y-4 text-gray-300">
                    <p><strong>${t.hello}</strong> <span class="font-semibold text-yellow-200">${personNameInput.value}</span></p>
                    <p><strong>${t.sunSign}</strong> <span class="font-semibold text-yellow-200">${details.sunSign}</span></p>
                    <p><strong>${t.moonSign}</strong> <span class="font-semibold text-yellow-200">${details.moonSign}</span></p>
                    <p><strong>${t.ascendant}</strong> <span class="font-semibold text-yellow-200">${details.ascendant}</span></p>
                    <p><strong>${t.houseDetails}</strong> ${details.houseDetails}</p>
                    <p><strong>${t.planetPositions}</strong> ${details.planetPositions}</p>
                    <hr class="border-gray-700 my-4" />
                    <h3 class="text-xl font-bold text-yellow-300">${t.monthlyRashifal}</h3>
                    <p>${details.monthlyRashifal}</p>
                    <h3 class="text-xl font-bold text-yellow-300">${t.annualRashifal}</h3>
                    <p>${details.annualRashifal}</p>
                </div>
            `;
        }
    </script>
</body>
</html>
