<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Simple Web App</title>
    <!-- Tailwind CSS CDN for easy styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background-color: #f3f4f6;
            font-family: 'Inter', sans-serif;
        }
        .note-card {
            background-color: white;
            padding: 1rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .note-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.15);
        }
        /* Custom modal styles to replace alert() and confirm() */
        #modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
        }
        #modal-box {
            background-color: white;
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            text-align: center;
            max-width: 400px;
            width: 90%;
        }
        #modal-close-btn {
            background-color: #3b82f6;
            color: white;
            font-weight: bold;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            margin-top: 1rem;
        }
    </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen p-4">

    <!-- Modal for displaying messages -->
    <div id="modal-backdrop" class="z-50">
        <div id="modal-box" class="rounded-lg shadow-lg">
            <p id="modal-message" class="text-xl font-semibold mb-4"></p>
            <button id="modal-close-btn" class="px-4 py-2 rounded-full">OK</button>
        </div>
    </div>

    <!-- Main application card -->
    <div class="bg-white rounded-xl shadow-lg p-6 max-w-2xl w-full space-y-6">
        <h1 class="text-3xl font-bold text-center text-gray-800">My Notes App</h1>
        <p class="text-center text-sm text-gray-500" id="user-info">Authenticating...</p>
        
        <!-- Form for adding a new note -->
        <div class="p-4 bg-gray-100 rounded-lg">
            <div class="mb-4">
                <input type="text" id="note-title" placeholder="Note Title" class="w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div class="mb-4">
                <textarea id="note-content" placeholder="Write your note here..." rows="4" class="w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
            </div>
            <button id="add-note-btn" class="w-full bg-blue-500 text-white font-bold py-3 rounded-lg hover:bg-blue-600 transition duration-200">
                Add Note
            </button>
        </div>

        <!-- Section for displaying notes -->
        <div class="space-y-4" id="notes-container">
            <h2 class="text-xl font-semibold text-gray-800">Your Notes</h2>
            <p id="loading-notes" class="text-center text-gray-500">Loading notes...</p>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, onSnapshot, collection, query, orderBy, deleteDoc, getDocs, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables for Firebase configuration
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // UI elements
        const userInfoEl = document.getElementById('user-info');
        const noteTitleEl = document.getElementById('note-title');
        const noteContentEl = document.getElementById('note-content');
        const addNoteBtn = document.getElementById('add-note-btn');
        const notesContainerEl = document.getElementById('notes-container');
        const loadingNotesEl = document.getElementById('loading-notes');
        const modalBackdrop = document.getElementById('modal-backdrop');
        const modalMessage = document.getElementById('modal-message');
        const modalCloseBtn = document.getElementById('modal-close-btn');

        // Show a custom modal message
        function showModal(message) {
            modalMessage.textContent = message;
            modalBackdrop.style.display = 'flex';
        }

        // Event listener for modal close button
        modalCloseBtn.addEventListener('click', () => {
            modalBackdrop.style.display = 'none';
        });

        // Initialize Firebase
        let app, db, auth, userId = null;

        window.onload = async function() {
            try {
                // Set Firestore log level for debugging
                setLogLevel('debug');

                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Authenticate the user
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("User authenticated:", userId);
                        userInfoEl.textContent = `User ID: ${userId}`;
                        setupRealtimeNotesListener();
                    } else {
                        console.log("No user is signed in.");
                        userInfoEl.textContent = "Please refresh the page to authenticate.";
                    }
                });
            } catch (error) {
                console.error("Firebase initialization or authentication failed:", error);
                showModal("Error: Could not initialize the app. Please check the console for details.");
            }
        };

        // Event listener for the "Add Note" button
        addNoteBtn.addEventListener('click', async () => {
            if (!userId) {
                showModal("Please wait for authentication to complete before adding a note.");
                return;
            }

            const title = noteTitleEl.value.trim();
            const content = noteContentEl.value.trim();

            if (title === "" || content === "") {
                showModal("Please enter both a title and content for your note.");
                return;
            }

            try {
                // Construct the path for the user's private notes collection
                const notesCollectionPath = `/artifacts/${appId}/users/${userId}/notes`;
                const notesCollectionRef = collection(db, notesCollectionPath);

                await addDoc(notesCollectionRef, {
                    title: title,
                    content: content,
                    timestamp: Date.now()
                });

                noteTitleEl.value = "";
                noteContentEl.value = "";
                showModal("Note added successfully!");
            } catch (error) {
                console.error("Error adding document:", error);
                showModal("Error adding note. Check the console for more details.");
            }
        });

        // Setup a real-time listener for the user's notes
        function setupRealtimeNotesListener() {
            if (!userId) {
                console.error("User ID not available for listener setup.");
                return;
            }

            const notesCollectionPath = `/artifacts/${appId}/users/${userId}/notes`;
            const notesCollectionRef = collection(db, notesCollectionPath);
            const notesQuery = query(notesCollectionRef);

            onSnapshot(notesQuery, (querySnapshot) => {
                loadingNotesEl.style.display = 'none';
                notesContainerEl.innerHTML = '<h2 class="text-xl font-semibold text-gray-800">Your Notes</h2>';
                
                if (querySnapshot.empty) {
                    notesContainerEl.innerHTML += '<p class="text-center text-gray-500 mt-2">No notes yet. Add one above!</p>';
                } else {
                    querySnapshot.forEach((doc) => {
                        const note = doc.data();
                        const noteId = doc.id;
                        const noteElement = document.createElement('div');
                        noteElement.className = 'note-card flex justify-between items-start';
                        noteElement.innerHTML = `
                            <div>
                                <h3 class="font-semibold text-lg">${note.title}</h3>
                                <p class="text-gray-600 text-sm">${note.content}</p>
                            </div>
                            <button class="delete-btn text-red-500 hover:text-red-700 font-bold" data-id="${noteId}">
                                &times;
                            </button>
                        `;
                        notesContainerEl.appendChild(noteElement);
                    });

                    // Add event listeners to all delete buttons
                    document.querySelectorAll('.delete-btn').forEach(button => {
                        button.addEventListener('click', async (e) => {
                            const noteIdToDelete = e.target.dataset.id;
                            const noteDocPath = `/artifacts/${appId}/users/${userId}/notes/${noteIdToDelete}`;
                            
                            try {
                                await deleteDoc(doc(db, noteDocPath));
                                showModal("Note deleted successfully!");
                            } catch (error) {
                                console.error("Error deleting document:", error);
                                showModal("Error deleting note. Check the console for more details.");
                            }
                        });
                    });
                }
            });
        }
    </script>
</body>
</html>
